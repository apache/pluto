<?xml version="1.0" encoding="UTF-8"?>
<project name="Portlets" default="build" basedir="../">

    <property name="debug" value="on"/>

    <!-- define default lib directories. As long as they are not set from a calling
         build.xml they use the base directories -->

    <property name="base.dir"             value="../"/>

    <property name="base.dir.lib"         value="${base.dir}/temp/jar/WEB-INF/lib"/>
    <property name="shared.dir.lib"       value="${base.dir}/driver/shared"/>

    <property name="portlet.dir"          value="${user.dir}"/>

    <property name="portlet.dir.src"      value="${portlet.dir}/src"/>
    <property name="portlet.dir.classes"  value="${portlet.dir}/classes"/>
    <property name="portlet.dir.lib"      value="${portlet.dir}/lib"/>
    <property name="portlet.dir.war"      value="${portlet.dir}/war"/>
    <property name="portlet.dir.driver"   value="${portlet.dir}/driver"/>

    <!-- Root directory of all portlets -->
    <property name="portlets.dir"        value="."/>
    <!-- Library path for all portlets-common jar files -->
    <property name="portlets.dir.lib"    value="${portlets.dir}/lib"/>

    <property file="${portlet.dir}/build.properties"/>

    <target name="build" depends="build.war"/>

    <target name="rebuild" depends="clean,build"/>

    <target name="init">
        <mkdir dir="${portlet.dir.classes}"/>
        <mkdir dir="${portlet.dir.driver}"/>
        <mkdir dir="${portlet.dir.lib}"/>       <!-- creates dir if not exists -->
        <mkdir dir="${portlets.dir.lib}"/>      <!-- creates dir if not exists -->
    </target>

    <target name="env" depends="init" unless="install">
        <echo message="Portlet Application ${portlet.dir} ..."/>
    </target>

    <target name="compile" depends="env">
        <!-- Copying the properties files -->
        <copy todir="${portlet.dir.classes}">
            <fileset dir="${portlet.dir.src}">
                <include name="**/*.properties"/>
                <include name="**/*.xsd"/>
                <include name="**/*.dtd"/>
            </fileset>
        </copy>

        <!-- Compiling the class files -->
        <javac srcdir="${portlet.dir.src}"
               destdir="${portlet.dir.classes}"
               includes="**/*.java"
               debug="${debug}">
            <classpath>
                <fileset dir="${portlet.dir.lib}">
                    <include name="**/*.jar"/>
                </fileset>
                <fileset dir="${base.dir.lib}">
                    <include name="**/*.jar"/>
                </fileset>
                <fileset dir="${shared.dir.lib}">
                    <include name="**/*.jar"/>
                </fileset>
                <!-- next common portlets specifiy .jar files -->
                <fileset dir="${portlets.dir.lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
        </javac>
    </target>

    <!-- Building the JAR file -->
    <target name="build.jar" depends="compile">
        <jar jarfile="${portlet.dir.classes}/${jarfile}" compress="true">
            <fileset dir="${portlet.dir.classes}">
                <exclude name="*.jar"/>
            </fileset>
        </jar>
    </target>

    <!-- Building the WAR file -->
    <target name="build.war" depends="build.jar">
        <jar jarfile="${portlet.dir.driver}/${warfile}">
            <fileset dir="${portlet.dir.war}">
                <exclude name="**/*.$$*"/>
            </fileset>
            <zipfileset dir="${portlet.dir.classes}" prefix="WEB-INF/lib">
                <include name="*.jar"/>
            </zipfileset>
        </jar>
    </target>

    <!-- Cleaning up the whole lot -->
    <target name="clean">
        <delete dir="${portlet.dir.classes}"/>
        <delete dir="${portlet.dir.driver}"/>
    </target>
</project>
