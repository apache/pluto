<!-- 
Copyright 2004 The Apache Software Foundation
Licensed  under the  Apache License,  Version 2.0  (the "License");
you may not use  this file  except in  compliance with the License.
You may obtain a copy of the License at 

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed  under the  License is distributed on an "AS IS" BASIS,
WITHOUT  WARRANTIES OR CONDITIONS  OF ANY KIND, either  express  or
implied.

See the License for the specific language governing permissions and
limitations under the License.
-->
<project default="multiproject:artifact"
         xmlns:j="jelly:core"
         xmlns:maven="jelly:maven"
         xmlns:ant="jelly:ant">

  <preGoal name="xdoc:jelly-transform">
    <attainGoal name="faq"/>
  </preGoal>   

  <preGoal name="fullDeployment">
    <attainGoal name="multiproject:install"/>
  </preGoal>

  <goal name="fullDeployment">
    <maven:reactor
            basedir="${basedir}"
            includes="portal/project.xml"
            goals="tomcat:deploy"
            banner="Deploying Portal"
            postProcessing="false"
            ignoreFailures="false"/>
    <maven:reactor
            basedir="${basedir}"
            includes="testsuite/project.xml"
            goals="deployTestsuite"
            banner="Deploying Test Suite to Pluto"
            postProcessing="false"
            ignoreFailures="false"/>  	
  </goal>

  <goal name="deploy">
    <echo>
************************************************
* Please ensure that a fullDeployment has      *
* previously been run if this deploy attempt   *
* fails.  It is the fullDeployment that        *
* deploys pluto container and portal driver.   *
************************************************
    </echo>
       <maven:reactor
               basedir="${basedir}"
               includes="deploy/project.xml"
               goals="deploy"
               banner="Deploy a portlet"
               postProcessing="false"
               ignoreFailures="false"/>  	  	  
  </goal>

  <goal name="website">
    <!-- this creates the website in "target/docs" -->
    <attainGoal name="multiproject:site"/>

    <!-- deploy the website to our server -->
    <attainGoal name="site:sshdeploy"/>
     
  </goal>

<!-- ========================= -->
<!-- Pluto Distributions Goals -->
<!-- ========================= -->

  <goal name="distribute:all">
    <attainGoal name="distribute:container"/>
    <attainGoal name="distribute:optional"/>
    <attainGoal name="distribute:tools"/>
  </goal>

<!-- ======================= -->
<!-- pluto-x.x distributions -->
<!-- ======================= -->

  <goal name="distribute:init">
    <j:set var="maven.dist.dir" value="${basedir}/target/distributions"/>
  </goal>

  <goal name="distribute:container" prereqs="distribute:init">
    <j:set var="pluto.dist.name" value="pluto-${pom.currentVersion}"/>
    <maven:reactor
            basedir="${basedir}"
            includes="container/project.xml"
			goals="dist:build"
            banner="Creating Pluto Container Distributions"
            postProcessing="false"
            ignoreFailures="false"/>
	<ant:copy 
      todir="${maven.dist.dir}"
	  file="${basedir}/container/target/distributions/${pluto.dist.name}.zip"/>
	<ant:copy 
      todir="${maven.dist.dir}"
	  file="${basedir}/container/target/distributions/${pluto.dist.name}.tar.gz"/>
  </goal>

<!-- ================================ -->
<!-- pluto-optional-x.x distributions -->
<!-- ================================ -->
  <goal name="distribute:optional">
    <j:set var="plutooptional.dist.name" 
           value="pluto-optional-${pom.currentVersion}"/>
    <!-- None Yet! -->
  </goal>

<!-- ============================ -->
<!-- pluto-tools-x.x distribution -->
<!-- ============================ -->
  <goal name="distribute:tools" prereqs="distribute:init">
    <j:set var="plutotools.dist.name" 
           value="pluto-tools-${pom.currentVersion}"/>
    <!-- STEP #1: Create archives and docs for each -->
    <maven:reactor
            basedir="${basedir}"
			includes="portal/project.xml"
			goals="war:war,javadoc:generate"
            banner="Creating Tools-Portal Distribution"
            postProcessing="false"
            ignoreFailures="false"/>
    <maven:reactor
            basedir="${basedir}"
			includes="testsuite/project.xml"
			goals="war:war,javadoc:generate"
            banner="Creating Tools-TestSuite Distribution"
            postProcessing="false"
            ignoreFailures="false"/>
    <maven:reactor
            basedir="${basedir}"
			includes="deploy/project.xml"
			goals="jar:jar,javadoc:generate"
            banner="Creating Tools-Deploy Distribution"
            postProcessing="false"
            ignoreFailures="false"/>

    <!-- -->
	<ant:copy todir="${maven.dist.dir}/${plutotools.dist.name}/">
      <ant:fileset dir="${basedir}" includes="LICENSE*"/>
	</ant:copy>

	<!-- STEP #2: Copy all to our dist dist dir -->
	<!--          First the driver. -->
	<ant:copy 
      tofile="${maven.dist.dir}/${plutotools.dist.name}/pluto-driver-${pom.currentVersion}.war"
      file="${basedir}/portal/target/pluto.war"/>

	<ant:copy todir="${maven.dist.dir}/${plutotools.dist.name}/docs/pluto-driver-${pom.currentVersion}">
      <ant:fileset dir="${basedir}/portal/target/docs" includes="apidocs/**/*"/>
	</ant:copy>

	<!--          Now the testsuite. -->
	<ant:copy 
			tofile="${maven.dist.dir}/${plutotools.dist.name}/pluto-testsuite-${pom.currentVersion}.war"
      file="${basedir}/testsuite/target/testsuite.war"/>

	<ant:copy todir="${maven.dist.dir}/${plutotools.dist.name}/docs/pluto-testsuite-${pom.currentVersion}">
      <ant:fileset dir="${basedir}/testsuite/target/docs" includes="apidocs/**/*"/>
	</ant:copy>

	<!--          What do we do for the deployer? -->

	<!-- STEP #3: Create the Distributions -->
	<ant:zip zipfile="${maven.dist.dir}/${plutotools.dist.name}.zip">
	  <ant:zipfileset 
		dir="${maven.dist.dir}"
        includes="${plutotools.dist.name}/**/*"/>
	</ant:zip>

	<ant:tar longfile="gnu" tarfile="${maven.dist.dir}/${plutotools.dist.name}.tar">
	  <ant:tarfileset dir="${maven.dist.dir}"
	      includes="${plutotools.dist.name}/**/*"/>
    </ant:tar>

    <ant:gzip 
      zipfile="${maven.dist.dir}/${plutotools.dist.name}.tar.gz"
      src="${maven.dist.dir}/${plutotools.dist.name}.tar"
    />

  </goal>
</project>

